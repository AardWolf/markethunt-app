<script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/9.3.2/highstock.min.js"></script>

<script>
var itemData = {{ item_metadata | json_encode | raw }};
</script>

<div id="chartBundle" style="max-width:800px; width: 100%; margin:auto;">
    <div id="chart-header-container">
        <div id="chart-header-left" class="chart-header-column">
            <h1 id="chartHeader" style="margin-bottom: 0px;">{% block chart_header %}{% endblock %}</h1>
            <div style="margin: 3px 0px;">
                <a id="chart-external-mh-link" href="#" target="_blank" rel="noopener noreferrer">
                    Open in Mousehunt<span class="material-icons" style="font-size:12px; vertical-align:top; text-shadow: none;">launch</span>
                </a>
            </div>
            <div style="margin: 10px 0px;">
                <button id="add-to-watchlist" class="pure-button pure-button-primary" onclick="addToWatchlistModal(null)">
                    Add to Watchlist
                </button>
                <button id="add-to-portfolio" class="pure-button pure-button-primary" onclick="addToPortfolioModal()">
                    Add to Portfolio
                </button>
            </div>
        </div>
        <div id="chart-header-right" class="chart-header-column">
            <div id="chart-header-price">--g</div>
            <div id="chart-header-change">-- (-- %)</div>
            <div id="chart-header-sb-index">-- SB</div>
        </div>
    </div>
    <div class="chart-loading-container">
        <div id="chartContainer" style="width:100%; height:550px; margin:auto;"></div>
        <div class="chart-loading">
            <!-- <img class="chart-loading-loader" src="/assets/img/ball.svg"> -->
        </div>
    </div>
    <form id="chartForm" action="javascript:;" onsubmit="" class="pure-form" style="margin: 5px 10px 15px 10px; display: flex;">
        <select id="chartSelector" name="item_id" onchange="handleChartSubmit()" style="width: 100%">
            <option value="" disabled selected hidden>Select an item</option>
            {% for item in item_metadata %}
                <option value="{{ item.item_id }}" {% if item.item_id == current_item_id %} selected="selected"{% endif %}>
                    {{- item.name -}}
                </option>
            {% endfor %}
        </select>
    </form>
    {% if include_credits %}
        <div class="credits">
            <p>Thanks to Chad and Coyu for their historical data.</p>
            <p>
                <a href="https://github.com/vsong/markethunt/issues">Leave feedback</a>
                | <a href="https://github.com/vsong/markethunt">Contribute</a>
            </p>
        </div>
    {% endif %}
</div>

<script src="/assets/js/chart.js"></script>

<div id="add-watchlist-dialog" style="display:none">
    <form id="add-watchlist-form" name="add-watchlist-form" class="pure-form pure-form-stacked">
        <fieldset>
            <label for="set-watch-price" class="pure-checkbox">
                <input type="checkbox" id="set-watch-price" /> Set price benchmark
            </label>
            <input type="number" id="watch-price" min=1 max=9999999999>
            <label for="comment">Comment</label>
            <input type="text" id="comment" />
            <label for="watchlist-select">Watchlist</label>
            <select type="text" id="watchlist-select" required></select>
            <div style="display: none;" id="new-watchlist-name-input-container">
                <label for="new-watchlist-name-addwatch">New watchlist name <span class="required-indicator">*</span></label>
                <input type="text" id="new-watchlist-name-addwatch" pattern=".+" />
            </div>
        </fieldset>
    </form>
    <p style="margin: 16px 0px 0px 0px;"><i>You can view your saved watches in the <a href="/watchlist.php">Watchlist</a> page.</i></p>
</div>

<script>
// set up watchlist dialog
$('#set-watch-price').change(function() {
    $('#watch-price').prop('disabled', !this.checked);
});

$('#watchlist-select').change(function() {
    if ($(this).val() === "newWatchlistOption") {
        $('#new-watchlist-name-addwatch').prop('required', true);
        $('#new-watchlist-name-input-container').css("display", "block");
    } else {
        $('#new-watchlist-name-addwatch').prop('required', false);
        $('#new-watchlist-name-input-container').css("display", "none");
    }
});

function addToWatchlistModal(price, editMode = false, editItemId = null, editComment = null, editWidx = null, editIdx = null) {
    var selector = document.getElementById('chartSelector');
    var itemId = editMode ? editItemId : Number(selector.value);

    var dialog = $("#add-watchlist-dialog").dialog({
        dialogClass: 'themed-titlebar',
        title: editMode ? 'Edit watchlist entry' : `Add ${selector.options[selector.selectedIndex].text} to watchlist`,
        draggable: false,
        autoOpen: false,
        modal: true,
        buttons: [
            {
                text: editMode? "Save changes" : "Add to watchlist",
                id: "add-to-watchlist-confirm",
                click: function() {
                    if (document.forms["add-watchlist-form"].reportValidity()) {
                        // get benchmark price, if any
                        if ($("#set-watch-price").is(':checked')) {
                            var inputPrice = Number($('#watch-price').val());
                            if (!Number.isInteger(inputPrice) || inputPrice < 1) {
                                console.log("Parsed input price is not a positive integer: " + inputPrice);
                                inputPrice = null;
                            }
                        } else {
                            var inputPrice = null;
                        }

                        // get the watchlist index that the new entry or edited entry will be inserted to
                        if ($('#watchlist-select').val() === "newWatchlistOption") {
                            var newWidx = getWatchlistObj().length;
                            processNewWatchlistFormData($('#new-watchlist-name-addwatch').val());
                        } else {
                            var newWidx = Number($('#watchlist-select').val());
                        }

                        if (editMode) {
                            processWatchlistEdit(editItemId, inputPrice, $('#comment').val(), editWidx, editIdx, newWidx);
                        } else {
                            processWatchlistFormData(inputPrice, $('#comment').val(), newWidx);
                        }

                        dialog.dialog("close");
                    }
                },
            },
            {
                text: "Cancel",
                id: "add-to-watchlist-cancel",
                click: function() {
                    dialog.dialog("close");
                },
            },
        ],
        open: function(event, ui) {
            // click outside to close
            $('.ui-widget-overlay').bind('click', function() { 
                dialog.dialog('close'); 
            });

            // override button classes
            $('#add-to-watchlist-confirm').removeClass().addClass("pure-button pure-button-primary");
            $('#add-to-watchlist-cancel').removeClass().addClass("pure-button");

            // set up benchmark and comment and clear data from last use
            if (price == null) {
                $('#set-watch-price').prop("checked", false);
                $('#watch-price').prop('disabled', true);
                $('#watch-price').val('');
            } else {
                $('#set-watch-price').prop("checked", true);
                $('#watch-price').prop('disabled', false);
                $('#watch-price').val(price);
            }

            $('#comment').val(editMode ? editComment : '');
            $('#new-watchlist-name-addwatch').val('');

            // show new watchlist inputs for edge case when user has no watchlists
            if (getWatchlistObj().length === 0) {
                $('#new-watchlist-name-addwatch').prop('required', true);
                $('#new-watchlist-name-input-container').css("display", "block");
            } else {
                $('#new-watchlist-name-addwatch').prop('required', false);
                $('#new-watchlist-name-input-container').css("display", "none");
            }

            // preserve selector value from last time
            var oldWidxVal = Number($('#watchlist-select').val());
            if (oldWidxVal >= getWatchlistObj().length) {
                oldWidxVal = 0;
            } else if (isNaN(oldWidxVal)) { // user made a new watchlist last time, so select it this time
                oldWidxVal = getWatchlistObj().length - 1;
            }

            // set up watchlist selector
            $('#watchlist-select').empty();
            getWatchlistObj().forEach(function(watchlist, widx) {
                $('#watchlist-select').append(`<option value="${widx}">${watchlist.name}</option>`);
            });
            $('#watchlist-select').append('<option value="newWatchlistOption">New watchlist ...</option>');
            if (editWidx !== null) {
                $('#watchlist-select').val(editWidx);
            } else {
                $('#watchlist-select').val(oldWidxVal);
            }
        }
    });

    dialog.dialog("open");
}

// Default implementations of watchlist form data handlers
function processNewWatchlistFormData(watchlistName) {
    var watchlists = getWatchlistObj();
    watchlists.push(newWatchlistObject(watchlistName));
    setWatchlistObj(watchlists);
}

function processWatchlistFormData(price, comment, widx) {
    var selector = document.getElementById('chartSelector');
    var itemId = Number(selector.value);
    var itemName = selector.options[selector.selectedIndex].text;
    var watchlist = getWatchlistObj();
    watchlist[widx].watches.push(newWatchlistItem(itemId, comment, (price == null) ? null : "gold", price));
    setWatchlistObj(watchlist);
    renderChartWithItemId(itemId, itemName);
}
</script>

<div id="add-portfolio-dialog" style="display:none">
    <form id="add-portfolio-form" name="add-portfolio-form" class="pure-form pure-form-stacked">
        <fieldset>
            <label for="position-qty">Quantity bought</label>
            <input type="number" id="position-qty" min=1 max=9999999999>
            <label for="position-mark">Buy price (ea)</label>
            <input type="number" id="position-mark" min=1 max=9999999999>
            <label for="portfolio-select">Portfolio</label>
            <select type="text" id="portfolio-select" required></select>
            <div style="display: none;" id="new-portfolio-name-input-container">
                <label for="new-portfolio-name-addportfolio">New portfolio name <span class="required-indicator">*</span></label>
                <input type="text" id="new-portfolio-name-addportfolio" pattern=".+" />
            </div>
        </fieldset>
    </form>
    <p style="margin: 16px 0px 0px 0px;"><i>You can view your portfolio in the <a href="/portfolio.php">Portfolio</a> page.</i></p>
</div>

<script>
// set up portfolio dialog
$('#portfolio-select').change(function() {
    if ($(this).val() === "newPortfolioOption") {
        $('#new-portfolio-name-addportfolio').prop('required', true);
        $('#new-portfolio-name-input-container').css("display", "block");
    } else {
        $('#new-portfolio-name-addportfolio').prop('required', false);
        $('#new-portfolio-name-input-container').css("display", "none");
    }
});

function addToPortfolioModal(editPositonObj = null, editPidx = null, editIdx = null) {
    var selector = document.getElementById('chartSelector');
    var savedPortfolios = getPortfolioObj();
    var itemId = editPositonObj ? editPositonObj.item_id : Number(selector.value);

    var dialog = $("#add-portfolio-dialog").dialog({
        dialogClass: 'themed-titlebar',
        title: editPositonObj ? 'Edit portfolio entry' : `Add ${selector.options[selector.selectedIndex].text} to portfolio`,
        draggable: false,
        autoOpen: false,
        modal: true,
        buttons: [
            {
                text: editPositonObj ? "Save changes" : "Add to portfolio",
                id: "add-to-portfolio-confirm",
                click: function() {
                    if (document.forms["add-portfolio-form"].reportValidity()) {
                        var inputQty = Number($('#position-qty').val());
                        var inputPrice = Number($('#position-mark').val());

                        // get the portfolio index that the new entry or edited entry will be inserted to
                        if ($('#portfolio-select').val() === "newPortfolioOption") {
                            var newPidx = savedPortfolios.length;
                            processNewPortfolioFormData($('#new-portfolio-name-addportfolio').val());
                        } else {
                            var newPidx = Number($('#portfolio-select').val());
                        }

                        if (editPositonObj) {
                            processPositionEdit(inputQty, inputPrice, editPidx, editIdx, newPidx);
                        } else {
                            processNewPositionFormData(inputQty, inputPrice, newPidx);
                        }

                        dialog.dialog("close");
                    }
                },
            },
            {
                text: "Cancel",
                id: "add-to-portfolio-cancel",
                click: function() {
                    dialog.dialog("close");
                },
            },
        ],
        open: function(event, ui) {
            // click outside to close
            $('.ui-widget-overlay').bind('click', function() { 
                dialog.dialog('close'); 
            });

            // override button classes
            $('#add-to-portfolio-confirm').removeClass().addClass("pure-button pure-button-primary");
            $('#add-to-portfolio-cancel').removeClass().addClass("pure-button");

            // set up qty and buy price
            if (editPositonObj === null) {
                $('#position-qty').val(1);
                $('#position-mark').val(itemData[itemId].latest_price);
            } else {
                $('#position-qty').val(editPositonObj.qty);
                $('#position-mark').val(editPositonObj.mark);
            }

            $('#new-portfolio-name-addportfolio').val('');

            // show new portfolio inputs for edge case when user has no portfolio
            if (savedPortfolios.length === 0) {
                $('#new-portfolio-name-addportfolio').prop('required', true);
                $('#new-portfolio-name-input-container').css("display", "block");
            } else {
                $('#new-portfolio-name-addportfolio').prop('required', false);
                $('#new-portfolio-name-input-container').css("display", "none");
            }

            // preserve portfolio selector value from last time
            var oldPidxVal = Number($('#portfolio-select').val());
            if (oldPidxVal >= savedPortfolios.length) {
                oldPidxVal = 0;
            } else if (isNaN(oldPidxVal)) { // user made a new watchlist last time, so select it this time
                oldPidxVal = getWatchlistObj().length - 1;
            }

            // set up portfolio selector
            $('#portfolio-select').empty();
            savedPortfolios.forEach(function(portfolio, pidx) {
                $('#portfolio-select').append(`<option value="${pidx}">${portfolio.name}</option>`);
            });
            $('#portfolio-select').append('<option value="newPortfolioOption">New portfolio ...</option>');
            if (editPositonObj !== null) {
                $('#portfolio-select').val(editPidx);
            } else {
                $('#portfolio-select').val(oldPidxVal);
            }
        }
    });

    dialog.dialog("open");
}

// Default implementations of watchlist form data handlers
function processNewPortfolioFormData(portfolioName) {
    var portfolios = getPortfolioObj();
    portfolios.push(newPortfolioObject(portfolioName));
    setPortfolioObj(portfolios);
}

function processNewPositionFormData(qty, mark, pidx) {
    var selector = document.getElementById('chartSelector');
    var itemId = Number(selector.value);
    var itemName = selector.options[selector.selectedIndex].text;
    var portfolios = getPortfolioObj();
    portfolios[pidx].positions.push(newPortfolioPosition(itemId, qty, mark));
    setPortfolioObj(portfolios);
    renderChartWithItemId(itemId, itemName);
}
</script>